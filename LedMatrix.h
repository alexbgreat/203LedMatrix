
#include <avr/pgmspace.h>

#include <avr/signal.h>
#include <avr/interrupt.h>
#include <util/delay.h>

#include <stdio.h>
#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/sleep.h>  
#include <avr/eeprom.h> 
#include <string.h>
#include <stdlib.h> 

/*
#include <avr/wdt.h> 
#define WATCHDOG_VALUE      WDTO_500MS
#define WATCHDOG_ENABLE     wdt_enable(WATCHDOG_VALUE);
#define WATCHDOG_DISABLE    wdt_disable();
*/

#ifndef F_CPU
#define F_CPU 8000000
#endif

#define INTERACTIVE_MODE    0   // Menu
#define SYNCHRONIZE         1   // Wait for new line before start to change message

#define EEPROM_CONFIG_ADDR_SPEED        0
#define EEPROM_CONFIG_ADDR_DIRECTION    1
#define EEPROM_CONFIG_ADDR_SPACING      2
#define EEPROM_CONFIG_ADDR_INTENSITY    3
#define EEPROM_CONFIG_ADDR_MESSAGE      10

// Pour savoir si la zone est valide ou non
#define EEPROM_MAGIC_CHAR   0xAA

#define INTERNAL_MESSAGE_COUNT          4

#define LOW(x)  ((x) & 0xFF)
#define HIGH(x) (((x) >> 8) & 0xFF) 

unsigned char scroll_speed = 5;
unsigned char scroll_direction = 1;
unsigned char char_spacing = 0;
signed int index = 0;
volatile int message_size = 0;

unsigned char verbose = 0;

unsigned char intensity = 0;

unsigned char auto_chain_message = 0;

uint8_t adc_value;

unsigned char speed_table[] = {
    0x00, 0x32, 0x4B, 0x7D, 0x96,
    0xAF, 0xC8, 0xE1, 0xF0, 0xFA
};

char char_spacing_value[] = { 5, 5, 4, 4, 3, 3, 3, 3, 2, 2 };

#define SET_MESSAGE(msg)    memset(message, 0, sizeof(message));    \
                            strcat(message, msg);                   \
                            message_size = strlen(message);

#if INTERACTIVE_MODE
#define MESSAGE_SIZE    1 + 120     // (1:magic character)
#else
#define MESSAGE_SIZE    350 - 3 - 1 // (3:speed,direction,spacing, 1:0)
#endif

// Calcul : value = timeout(sec) / (1 / F_CPU * 1024 * 255)
unsigned int watchdog_table[] = {
    0,      306,    916,    1838,   3676,   // 0:off,   1:10 sec,   2:30 sec, 3:1 min,  4:2 min
    5515,   9191,   18382,  36765, 55147    // 5:3 min, 6:5 min,    7:10 min, 8:20 min, 9:30 min
};
unsigned int watchdog_counter = 0;
unsigned char watchdog_value = 0;
#define WATCHDOG_ERROR_MSG  "Watchdog error : no com !"
#define WATCHDOG_RESET      watchdog_counter = 0;


char message[MESSAGE_SIZE]; //160
unsigned char current_message = 0;

extern volatile char receivedBuffer;

#include "usart.h"

static FILE mystdout = FDEV_SETUP_STREAM(USART_SendByte, NULL, _FDEV_SETUP_WRITE);

#include "font5x7.h"

#define _DDRB   0
#define _DDRC   1
#define _DDRD   2
#define _PORTB  3
#define _PORTC  4
#define _PORTD  5

#define MATRIX_COL_COUNT 29
#define MATRIX_LINE_COUNT 7

#define STEP 1

unsigned char matrix[29][7][6] PROGMEM = {

    // 0
    {
        { 4,        4,      0,      4,      0,      0   },
        { 2,        4,      0,      2,      0,      0   },
        { 1,        4,      0,      1,      0,      0   },
        { 0,        4,      128,    0,      0,      128 },
        { 0,        4,      32,     0,      0,      32  },
        { 128,      4,      0,      128,    0,      0   },
        { 64,       4,      0,      64,     0,      0   },
    },

    // 1
    {
        { 4,         0,     64,     0,      0,      64 },
        { 2,         0,     64,     0,      0,      64 },
        { 1,         0,     64,     0,      0,      64 },
        { 0,         0,     64+128, 0,      0,      64 },
        { 0,         0,     64+32,  0,      0,      64 },
        { 128,       0,     64,     0,      0,      64 },
        { 64,        0,     64,     0,      0,      64 }
    },

    // 2
    {
        { 4,         0,     64,     4,      0,      0 },
        { 2,         0,     64,     2,      0,      0 },
        { 1,         0,     64,     1,      0,      0 },
        { 0,         0,     64+128, 0,      0,      128 },
        { 0,         0,     64+32,  0,      0,      32 },
        { 128,       0,     64,     128,    0,      0 },
        { 64,        0,     64,     64,     0,      0 }
    },

    // 3
    {
        { 4+8,         0,     0,      8,      0,      0 },
        { 2+8,         0,     0,      8,      0,      0 },
        { 1+8,         0,     0,      8,      0,      0 },
        { 0+8,         0,     128,    8,      0,      0 },
        { 0+8,         0,     32,     8,      0,      0 },
        { 128+8,       0,     0,      8,      0,      0 },
        { 64+8,        0,     0,      8,      0,      0 }
    },

    // 4
    {
        { 4+8,         0,     0,      4,      0,      0 },
        { 2+8,         0,     0,      2,      0,      0 },
        { 1+8,         0,     0,      1,      0,      0 },
        { 0+8,         0,     128,    0,      0,      128 },
        { 0+8,         0,     32,     0,      0,      32 },
        { 128+8,       0,     0,      128,      0,      0 },
        { 64+8,        0,     0,      64,      0,      0 }
    },

    // 5
    {
        { 4+16,         0,     0,      16,      0,      0 },
        { 2+16,         0,     0,      16,      0,      0 },
        { 1+16,         0,     0,      16,      0,      0 },
        { 0+16,         0,     128,    16,      0,      0 },
        { 0+16,         0,     32,     16,      0,      0 },
        { 128+16,       0,     0,      16,      0,      0 },
        { 64+16,        0,     0,      16,      0,      0 }
    },

    // 6
    {
        { 4+16,         0,     0,      4,      0,      0 },
        { 2+16,         0,     0,      2,      0,      0 },
        { 1+16,         0,     0,      1,      0,      0 },
        { 0+16,         0,     128,    0,      0,      128 },
        { 0+16,         0,     32,     0,      0,      32 },
        { 128+16,       0,     0,      128,      0,      0 },
        { 64+16,        0,     0,      64,      0,      0 }
    },

    // 7
    {
        { 4+32,         0,     0,      32,      0,      0 },
        { 2+32,         0,     0,      32,      0,      0 },
        { 1+32,         0,     0,      32,      0,      0 }, // Souci sous 5v
        { 0+32,         0,     128,    32,      0,      0 },       
        { 0+32,         0,     32,     32,      0,      0 },
        { 128+32,       0,     0,      32,      0,      0 },
        { 64+32,        0,     0,      32,      0,      0 }
    },

    // 8
    {
        { 4+32,         0,     0,      4,      0,      0 },
        { 2+32,         0,     0,      2,      0,      0 },
        { 1+32,         0,     0,      1,      0,      0 },
        { 0+32,         0,     128,    0,      0,      128 },
        { 0+32,         0,     32,     0,      0,      32 },
        { 128+32,       0,     0,      128,      0,      0 },
        { 64+32,        0,     0,      64,      0,      0 }
    },

    // 9
    {
        { 4,         1,     0,      0,      1,      0 },
        { 2,         1,     0,      0,      1,      0 },
        { 1,         1,     0,      0,      1,      0 },
        { 0,         1,     128,    0,      1,      0 },
        { 0,         1,     32,     0,      1,      0 },
        { 128,       1,     0,      0,      1,      0 },
        { 64,        1,     0,      0,      1,      0 }
    },

    // 10
    {
        { 4,         1,     0,      4,      0,      0 },
        { 2,         1,     0,      2,      0,      0 },
        { 1,         1,     0,      1,      0,      0 },
        { 0,         1,     128,    0,      0,      128 },
        { 0,         1,     32,     0,      0,      32 },
        { 128,       1,     0,      128,      0,      0 },
        { 64,        1,     0,      64,      0,      0 }
    },

    // 11
    {
        { 4,         8,     0,      0,      8,      0 },
        { 2,         8,     0,      0,      8,      0 },
        { 1,         8,     0,      0,      8,      0 },
        { 0,         8,     128,    0,      8,      0 },
        { 0,         8,     32,     0,      8,      0 },
        { 128,       8,     0,      0,      8,      0 },
        { 64,        8,     0,      0,      8,      0 }
    },

    // 12
    {
        { 4,         8,     0,      4,      0,      0 },
        { 2,         8,     0,      2,      0,      0 },
        { 1,         8,     0,      1,      0,      0 },
        { 0,         8,     128,    0,      0,      128 },
        { 0,         8,     32,     0,      0,      32 },
        { 128,       8,     0,      128,    0,      0 },
        { 64,        8,     0,      64,     0,      0 }
    },

    // 13
    {
        { 4,         2,     0,      0,      2,      0 },
        { 2,         2,     0,      0,      2,      0 },
        { 1,         2,     0,      0,      2,      0 },
        { 0,         2,     128,    0,      2,      0 },
        { 0,         2,     32,     0,      2,      0 },
        { 128,       2,     0,      0,      2,      0 },
        { 64,        2,     0,      0,      2,      0 }
    },

    // 14
    {
        { 4,         2,     0,      4,      0,      0 },
        { 2,         2,     0,      2,      0,      0 },
        { 1,         2,     0,      1,      0,      0 },
        { 0,         2,     128,    0,      0,      128 },
        { 0,         2,     32,     0,      0,      32 },
        { 128,       2,     0,      128,    0,      0 },
        { 64,        2,     0,      64,     0,      0 }
    },

    // 15
    {
        { 4+64,         0,     0,      64,      0,      0 },
        { 2+64,         0,     0,      64,      0,      0 },
        { 1+64,         0,     0,      64,      0,      0 },
        { 64,         0,     128,    64,      0,      0 },
        { 64,         0,     32,     64,      0,      0 },
        { 128+64,       0,     0,      64,      0,      0 },
        { 0,        8+2,     0,      0,      8,      0 }
    },

    // 16
    {
        { 4+64,         0,     0,      4,      0,      0 },
        { 2+64,         0,     0,      2,      0,      0 },
        { 1+64,         0,     0,      1,      0,      0 },
        { 0+64,         0,     128,    0,      0,      128 },
        { 0+64,         0,     32,     0,      0,      32 },
        { 128+64,       0,     0,      128,    0,      0 },
        { 0,        8+2,     0,      0,     2,      0 }
    },

    // 17
    {
        { 4+128,         0,     0,      128,      0,      0 },
        { 2+128,         0,     0,      128,      0,      0 },
        { 1+128,         0,     0,      128,      0,      0 },
        { 128,         0,     128,    128,      0,      0 },
        { 128,         0,     32,     128,      0,      0 },
        { 0,       1+8,     0,      128,      1,      0 },
        { 0,        1+2,     0,      0,      1,      0 }
    },

    // 18
    {
        { 4+128,         0,     0,      4,      0,      0 },
        { 2+128,         0,     0,      2,      0,      0 },
        { 1+128,         0,     0,      1,      0,      0 },
        { 128,         0,     128,    0,      0,      128 },
        { 128,         0,     32,     0,      0,      32 },
        { 0,       1+8,     0,      0,      8,      0 },
        { 0,        1+2,     0,      0,      2,      0 }
    },

    // 19
    {
        { 4,         0,     32,      0,      0,      32 },
        { 2,         0,     32,      0,      0,      32 },
        { 1,         0,     32,      0,      0,      32 },
        { 0,         0,     128+32,    0,      0,      32 },
        { 32,         1,     0,     32,      0,      0 },
        { 32,       8,     0,      32,      0,      0 },
        { 32,        2,     0,      32,      0,      0 }
    },

    // 20
    {
        { 4,         0,     32,      4,      0,      0 },
        { 2,         0,     32,      2,      0,      0 },
        { 1,         0,     32,      1,      0,      0 },
        { 0,         0,     128+32,    0,      0,      128 },
        { 32,         1,     0,     0,      1,      0 },
        { 32,       8,     0,      0,      8,      0 },
        { 32,        2,     0,      0,      2,      0 }
    },

    // 21
    {
        { 4,         0,     128,      0,      0,      128 },
        { 2,         0,     128,      0,      0,      128 },
        { 1,         0,     128,      0,      0,      128 },
        { 16+32,     0,     0,    16,      0,      0 },
        { 16,         1,     0,     16,      0,      0 },
        { 16,       8,     0,      16,      0,      0 },
        { 16,        2,     0,      16,      0,      0 }
    },

    // 22
    {
        { 4,         0,     128,      4,      0,      0 },
        { 2,         0,     128,      2,      0,      0 },
        { 1,         0,     128,      1,      0,      0 },
        { 16+32,     0,     0,    32,      0,      0 },
        { 16,         1,     0,     0,      1,      0 },
        { 16,       8,     0,      0,      8,      0 },
        { 16,        2,     0,      0,      2,      0 }
    },

    // 23
    {
        { 4+1,      0,     0,      1,      0,      0 },
        { 2+1,      0,     0,      1,      0,      0 },
        { 8+16,     0,     0,      8,      0,      0 },
        { 8+32,     0,     0,    8,      0,      0 },
        { 8,        1,     0,     8,      0,      0 },
        { 8,        8,     0,      8,      0,      0 },
        { 8,        2,     0,      8,      0,      0 }
    },

    // 24
    {
        { 4+1,      0,     0,      4,      0,      0 },
        { 2+1,      0,     0,      2,      0,      0 },
        { 8+16,     0,     0,      16,      0,      0 },
        { 8+32,     0,     0,    32,      0,      0 },
        { 8,        1,     0,     0,      1,      0 },
        { 8,        8,     0,      0,      8,      0 },
        { 8,        2,     0,      0,      2,      0 }
    },

    // 25
    {
        { 4+2,      0,     0,      2,      0,      0 },
        { 8,      0,     64,      0,      0,      64 },
        { 16,     0,     64,      0,      0,      64 },
        { 32,     0,     64,    0,      0,      64 },
        { 0,        1,     64,     0,      0,      64 },
        { 0,        8,     64,      0,      0,      64 },
        { 0,        2,     64,      0,      0,      64 }
    },

    // 26
    {
        { 4+2,      0,     0,      4,      0,      0 },
        { 8,      0,     64,      8,      0,      0 },
        { 16,     0,     64,      16,      0,      0 },
        { 32,     0,     64,    32,      0,      0 },
        { 0,        1,     64,     0,      1,      0 },
        { 0,        8,     64,      0,      8,      0 },
        { 0,        2,     64,      0,      2,      0 }
    },

    // 27
    {
        { 0,      4,     64,      0,     4,      0 },
        { 8,      4,     0,      0,      4,      0 },
        { 16,     4,     0,      0,      4,      0 },
        { 32,     4,     0,    0,      4,      0 },
        { 0,        4+1,     0,     0,      4,      0 },
        { 0,        4+8,     0,      0,      4,      0 },
        { 0,        4+2,     0,      0,      4,      0 }
    },

    // 28
    {
        { 0,      4,     64,      0,      0,      64 },
        { 8,      4,     0,      8,      0,      0 },
        { 16,     4,     0,      16,      0,      0 },
        { 32,     4,     0,    32,      0,      0 },
        { 0,      4+1,   0,     0,      1,      0 },
        { 0,      4+8,   0,      0,      8,      0 },
        { 0,      4+2,   0,         0,      2,      0 }
    }
};

